<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SheetLink</title>
  <link rel="stylesheet" href="popup.css">
  <link rel="stylesheet" href="components/WalkthroughModal.css">
</head>
<body>
  <div class="container">
    <!-- Default header (shown before Google auth) -->
    <header id="default-header">
      <img src="../assets/brand/sheetlink-logo-horizontal-white.svg" alt="SheetLink" class="logo" width="144" height="36">
      <p class="subtitle" id="headerSubtitle">Forget dashboards. Feed your spreadsheet.</p>
    </header>

    <!-- User control panel header (shown after Google auth) -->
    <header id="user-header" class="user-header hidden">
      <div class="user-profile">
        <div class="user-avatar" id="userAvatar">
          <span id="userInitial">U</span>
        </div>
        <div class="user-info">
          <div class="user-email" id="userEmail">user@gmail.com</div>
        </div>
      </div>
      <div class="connection-indicators">
        <div class="indicator bank-indicator" id="bankIndicator" title="Bank connection">
          <span class="indicator-icon">üè¶</span>
        </div>
        <div class="indicator sheet-indicator" id="sheetIndicator" title="Sheet connection">
          <span class="indicator-icon">üìä</span>
        </div>
      </div>
    </header>

    <main id="mainContent">
      <!-- Onboarding Pages (shown during initial setup) -->
      <!-- Welcome Screen (First Time) -->
      <div id="welcomeSection" class="section welcome-hero hidden">
        <!-- Hero Section with Green Gradient -->
        <div class="welcome-hero-bg">
          <img src="../assets/brand/sheetlink-logo-horizontal-white.svg" alt="SheetLink" class="welcome-logo" width="180" height="45">
          <p class="welcome-tagline">Forget dashboards. Feed your spreadsheet.</p>
        </div>

        <!-- Sign In Section -->
        <div class="welcome-content">
          <button id="signInGoogleBtn" class="btn btn-google">
            <svg class="google-icon" width="18" height="18" viewBox="0 0 18 18" xmlns="http://www.w3.org/2000/svg">
              <path d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z" fill="#4285F4"/>
              <path d="M9.003 18c2.43 0 4.467-.806 5.956-2.18L12.05 13.56c-.806.54-1.836.86-3.047.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332C2.438 15.983 5.482 18 9.003 18z" fill="#34A853"/>
              <path d="M3.964 10.71c-.18-.54-.282-1.117-.282-1.71s.102-1.17.282-1.71V4.958H.957C.347 6.173 0 7.548 0 9s.348 2.827.957 4.042l3.007-2.332z" fill="#FBBC05"/>
              <path d="M9.003 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.464.891 11.426 0 9.003 0 5.482 0 2.438 2.017.957 4.958L3.964 7.29c.708-2.127 2.692-3.71 5.036-3.71z" fill="#EA4335"/>
            </svg>
            Continue with Google
          </button>

          <a href="https://sheetlink.app" id="welcomeLearnMore" class="welcome-learn-more" target="_blank">
            Learn more
          </a>
        </div>

        <!-- Privacy Footer -->
        <div class="welcome-footer">
          <p class="welcome-privacy">
            üîí Your credentials are encrypted and never stored by SheetLink
          </p>
        </div>
      </div>

      <!-- Status Display -->
      <div id="statusSection" class="section hidden">
        <div class="status-card">
          <div class="status-icon" id="statusIcon">‚úì</div>
          <div class="status-text" id="statusText">Not connected</div>
        </div>

        <!-- Collapsible Bank Connection Details -->
        <details id="bankConnectionDetails" class="bank-details" style="margin-top: 12px; display: none;">
          <summary style="cursor: pointer; font-size: 13px; font-weight: 500; color: #1a73e8; padding: 8px; background: #f9fafb; border-radius: 6px; list-style: none; display: flex; align-items: center; gap: 6px;">
            <span id="dropdownArrow" style="transition: transform 0.2s;">‚ñ∂</span>
            <span>View connection details</span>
          </summary>
          <div id="bankConnectionDetailsContent" style="margin-top: 8px; padding: 12px; background: #f9fafb; border-radius: 6px; font-size: 13px;">
            <!-- Content will be populated by JavaScript -->
          </div>
        </details>
      </div>

      <!-- Connect Bank Section -->
      <div id="connectSection" class="section hidden">
        <div class="step-progress">
          <div class="step-label">Step 2 of 3 ‚Äî Connect Your Bank</div>
        </div>

        <div class="signed-in-badge">
          <span class="badge-icon">‚úì</span>
          <span class="badge-text">Signed in as: <span id="connectedUserEmail">user@gmail.com</span></span>
        </div>

        <!-- Connection Status (shown when bank already connected) -->
        <div id="bankConnectionStatus" class="hidden" style="margin: 16px 0; padding: 12px; background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 6px;">
          <div style="display: flex; align-items: center; gap: 8px; font-size: 14px; color: #166534; font-weight: 500;">
            <span>‚úì</span>
            <span>Bank Connected</span>
          </div>
        </div>

        <p style="font-size: 14px; color: #374151; margin: 16px 0; line-height: 1.6;">
          SheetLink uses Plaid to securely connect to 12,000+ banks. Your credentials are encrypted and never stored by SheetLink.
        </p>

        <button id="connectBankBtn" class="btn btn-primary">
          Connect Bank via Plaid
        </button>

        <!-- Update Connection Button (shown when bank already connected) -->
        <button id="updateConnectionBtn" class="btn btn-secondary hidden" style="margin-top: 8px;">
          Update Connection
        </button>

        <div class="security-badge" style="margin-top: 16px; display: flex; align-items: center; justify-content: center; gap: 6px; font-size: 12px; color: #6b7280;">
          <span>üîí</span>
          <span>Bank-level encryption</span>
        </div>
      </div>

      <!-- Sheet Selection Section -->
      <div id="sheetSection" class="section hidden">
        <div class="step-progress">
          <div class="step-label">Step 3 of 3 ‚Äî Link Your Google Sheet</div>
        </div>

        <h3 style="margin-bottom: 8px; font-size: 16px;">Update your Google Sheet</h3>
        <p style="font-size: 13px; color: #666; margin-bottom: 4px;">
          Paste the URL of the Google Sheet where you want SheetLink to send your data.
        </p>
        <p style="font-size: 12px; color: #9ca3af; margin-bottom: 12px;">
          Use a sheet owned by <span id="sheetUserEmail" style="color: #6b7280; font-weight: 500;">user@gmail.com</span>
        </p>

        <!-- Inline error banner for sheet save failures (Phase 3.9.2: Enhanced error messaging) -->
        <div id="sheetErrorBanner" class="error-banner hidden" style="margin-bottom: 12px; padding: 12px; background: #fef2f2; border: 1px solid #fecaca; border-radius: 6px;">
          <div style="font-weight: 600; color: #991b1b; margin-bottom: 6px; font-size: 14px;">Cannot Access Google Sheet</div>
          <div id="sheetErrorDetail" style="font-size: 13px; color: #7f1d1d; line-height: 1.5;"></div>
        </div>

        <label for="sheetUrl">Google Sheet URL</label>
        <input
          type="text"
          id="sheetUrl"
          placeholder="https://docs.google.com/spreadsheets/d/..."
        >
        <button id="saveSheetBtn" class="btn btn-secondary">
          Save Sheet
        </button>
        <button id="removeSheetBtn" class="btn btn-text" style="margin-top: 8px;">
          Remove Sheet
        </button>
      </div>

      <!-- Post-Onboarding Pages (shown after full connection) -->
      <!-- Home Page -->
      <div id="page-home" class="page hidden">
        <h2 style="margin-bottom: 16px; font-size: 18px; font-weight: 600;">Dashboard</h2>

        <!-- Sync Section -->
        <div class="sync-section card">
          <button id="homeSyncBtn" class="btn btn-primary">Sync Now</button>
          <p class="last-sync" style="margin-top: 12px; font-size: 13px; color: #6b7280;">
            Last sync: <span id="homeLastSync">Never</span>
          </p>
          <p class="plan-tier" style="margin-top: 4px; font-size: 13px;">
            <span style="color: #6b7280;">Plan:</span>
            <span id="homePlanTier" style="font-weight: 600; color: #3b82f6;">Free (7 days)</span>
          </p>
        </div>

        <!-- Connection Status -->
        <div class="status-section card" style="margin-top: 12px;">
          <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 8px;">Connection Status</h3>
          <div id="homeStatusPlaid" class="status-item" style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
            <span class="status-icon" style="color: #10b981;">‚úì</span>
            <span style="font-size: 13px;">Plaid connection active</span>
          </div>
          <div id="homeStatusSheet" class="status-item" style="display: flex; align-items: center; gap: 8px;">
            <span class="status-icon" style="color: #10b981;">‚úì</span>
            <span style="font-size: 13px;">Sheet linked</span>
          </div>
        </div>

        <!-- Auto-Sync Section -->
        <div class="auto-sync-section card" style="margin-top: 12px;">
          <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 8px;">Auto-Sync</h3>
          <div style="display: flex; align-items: center; justify-content: space-between;">
            <span style="font-size: 13px; color: #6b7280;">Automatic daily syncs</span>
            <label class="toggle-switch disabled" title="Upgrade required">
              <input type="checkbox" disabled id="homeAutoSyncToggle">
              <span class="slider"></span>
            </label>
          </div>
          <p class="upgrade-note" style="margin-top: 8px; font-size: 12px; color: #9ca3af;">Available with paid plans</p>
        </div>

        <!-- Upgrade Placeholder -->
        <div class="upgrade-placeholder" style="margin-top: 16px; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; text-align: center;">
          <div style="font-size: 14px; font-weight: 600; color: white; margin-bottom: 8px;">
            Want more history?
          </div>
          <div style="font-size: 12px; color: rgba(255, 255, 255, 0.9); margin-bottom: 12px;">
            Upgrade to get 90 days (Basic) or 2 years (Pro) of transaction history, plus auto-sync.
          </div>
          <button id="homeUpgradeBtn" class="btn btn-secondary" disabled style="opacity: 0.7; cursor: not-allowed;">
            Upgrade (coming soon)
          </button>
        </div>
      </div>

      <!-- Bank Page -->
      <div id="page-bank" class="page hidden">
        <h2 style="margin-bottom: 16px; font-size: 18px; font-weight: 600;">Your Banks</h2>

        <!-- Connected Institutions -->
        <div id="bankList" class="bank-list">
          <!-- Dynamically populated -->
          <div class="bank-card card">
            <div class="bank-header" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
              <h3 class="institution-name" id="bankInstitutionName" style="font-size: 16px; font-weight: 600;">Chase</h3>
              <span class="connection-status active" style="font-size: 12px; color: #10b981; font-weight: 500;">Active</span>
            </div>
            <div class="accounts-list" id="bankAccountsList">
              <!-- Accounts populated by JS -->
              <div class="account-item" style="font-size: 13px; color: #6b7280; margin-bottom: 4px;">
                <span>Loading accounts...</span>
              </div>
            </div>
            <button id="updateBankConnectionBtn" class="btn btn-secondary" style="margin-top: 12px;">Update Connection</button>
          </div>
        </div>

        <!-- Add Bank Button (for future multi-account support) -->
        <button id="addBankBtn" class="btn btn-primary" style="margin-top: 12px;">Add Bank</button>

        <!-- Disconnect Bank -->
        <button id="disconnectBankBtn" class="btn btn-text" style="margin-top: 8px; color: #ef4444;">Disconnect Bank</button>
      </div>

      <!-- Sheet Page -->
      <div id="page-sheet" class="page hidden">
        <h2 style="margin-bottom: 16px; font-size: 18px; font-weight: 600;">Your Google Sheet</h2>

        <!-- Sheet Info -->
        <div class="sheet-info card">
          <div class="status-item" style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
            <span class="status-icon" style="color: #10b981;">‚úì</span>
            <span style="font-size: 14px; font-weight: 500;">Connected to Sheet</span>
          </div>
          <p class="sheet-url" style="margin-bottom: 8px;">
            <a id="sheetLink" href="#" target="_blank" style="font-size: 13px; color: #3b82f6; text-decoration: none;">Open Sheet ‚Üí</a>
          </p>
          <p class="sheet-owner" style="font-size: 13px; color: #6b7280; margin-bottom: 4px;">
            Owner: <span id="sheetOwner">user@gmail.com</span>
          </p>
          <p class="sheet-last-write" style="font-size: 13px; color: #6b7280;">
            Last write: <span id="sheetLastWrite">2 hours ago</span>
          </p>
        </div>

        <!-- Actions -->
        <div class="sheet-actions" style="margin-top: 12px;">
          <button id="changeSheetBtnPage" class="btn btn-secondary">Change Sheet</button>
          <button id="disconnectSheetBtn" class="btn btn-text" style="margin-top: 8px; color: #ef4444;">Disconnect Sheet</button>
        </div>
      </div>

      <!-- Legacy Sync Section (kept for backward compatibility during onboarding) -->
      <div id="syncSection" class="section hidden">
        <!-- Sync error banner for sheet access issues -->
        <div id="syncErrorBanner" class="error-banner hidden" style="margin-bottom: 12px; padding: 10px; background: #fef2f2; border: 1px solid #fecaca; border-radius: 6px;">
          <div style="font-weight: 600; color: #991b1b; margin-bottom: 4px;">We cannot access your Google Sheet</div>
          <div style="font-size: 13px; color: #7f1d1d; margin-bottom: 8px;">
            Check that the sheet still exists, that the link is correct, and that SheetLink has edit access.
          </div>
          <div style="display: flex; gap: 8px;">
            <button id="changeSheetLinkBtn" class="btn btn-secondary" style="font-size: 13px; padding: 6px 12px;">
              Change Sheet Link
            </button>
            <button id="retrySyncBtn" class="btn btn-text" style="font-size: 13px;">
              Retry
            </button>
          </div>
        </div>

        <div class="sync-info">
          <!-- Google Account Badge -->
          <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 12px; padding: 8px; background: #f9fafb; border-radius: 6px; font-size: 12px; color: #374151;">
            <span>üë§</span>
            <span id="syncGoogleEmail" style="font-weight: 500;">user@gmail.com</span>
          </div>

          <div class="sheet-row">
            <div class="sheet-main">
              <span class="sheet-label">Sheet:</span>
              <span id="currentSheet" class="sheet-id">Not connected yet</span>
            </div>
            <button id="changeSheetBtn" class="sheet-change-btn hidden">
              Change sheet
            </button>
          </div>
          <p>Last sync: <span id="lastSync">Never</span></p>
          <p style="margin-top: 4px;">
            <span style="font-size: 12px; color: #666;">Plan:</span>
            <span id="subscriptionTier" style="font-size: 12px; font-weight: 600; color: #1a73e8;">Free (7 days)</span>
          </p>
        </div>
        <button id="syncNowBtn" class="btn btn-primary">
          Sync Now
        </button>
        <button id="generateTestBtn" class="btn btn-secondary" style="margin-top: 8px;">
          Generate Test Transactions (Sandbox)
        </button>

        <!-- Auto-Sync Status -->
        <div class="auto-sync-card" style="display: none; margin-top: 16px; padding: 12px; background: #f5f5f5; border-radius: 8px;">
          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
            <span style="font-weight: 600;">‚è∞ Auto-Sync</span>
            <span id="schedulerStatus" style="font-size: 12px; color: #666;">Checking...</span>
          </div>
          <div style="font-size: 13px; color: #666; margin-bottom: 8px;">
            Next run: <span id="nextRunTime">-</span>
          </div>
          <details style="font-size: 12px;">
            <summary style="cursor: pointer; color: #1a73e8;">Recent syncs</summary>
            <div id="recentSyncs" style="margin-top: 8px; max-height: 150px; overflow-y: auto;">
              Loading...
            </div>
          </details>
        </div>

        <!-- Upgrade Placeholder (Phase 3) -->
        <div class="upgrade-placeholder" style="margin-top: 16px; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; text-align: center;">
          <div style="font-size: 14px; font-weight: 600; color: white; margin-bottom: 8px;">
            Want more history?
          </div>
          <div style="font-size: 12px; color: rgba(255, 255, 255, 0.9); margin-bottom: 12px;">
            Upgrade to get 90 days (Basic) or 2 years (Pro) of transaction history, plus auto-sync.
          </div>
          <button id="upgradeBtn" class="btn btn-secondary" disabled style="opacity: 0.7; cursor: not-allowed;">
            Upgrade (coming soon)
          </button>
        </div>
      </div>

      <!-- Templates Section -->
      <div id="templatesSection" class="section hidden">
        <h2 style="margin-bottom: 12px; font-size: 18px;">üìö Template Gallery</h2>
        <p style="font-size: 13px; color: #666; margin-bottom: 16px;">
          Pre-built templates to jumpstart your financial tracking
        </p>

        <div id="templatesList">
          <div style="text-align: center; padding: 20px; color: #666;">
            Loading templates...
          </div>
        </div>
      </div>

      <!-- Error Display -->
      <div id="errorSection" class="section hidden">
        <div class="error-card">
          <p id="errorMessage"></p>
          <button id="retryBtn" class="btn btn-secondary">Retry</button>
        </div>
      </div>

      <!-- Loading Indicator -->
      <div id="loadingSection" class="section hidden">
        <div class="loader"></div>
        <p id="loadingMessage">Processing...</p>
      </div>
    </main>

    <!-- Legacy footer (shown during onboarding) -->
    <footer id="legacy-footer">
      <button id="templatesBtn" class="btn btn-text hidden">
        Templates
      </button>
      <button id="disconnectBtn" class="btn btn-text hidden">
        Disconnect Bank
      </button>
      <button id="optionsBtn" class="btn btn-text">
        Options
      </button>
    </footer>

    <!-- Footer Navigation (shown after onboarding complete) -->
    <footer id="footer-nav" class="footer-nav hidden">
      <button class="nav-tab active" data-page="home">
        <span class="nav-icon">üè†</span>
        <span class="nav-label">Home</span>
      </button>
      <button class="nav-tab" data-page="bank">
        <span class="nav-icon">üè¶</span>
        <span class="nav-label">Bank</span>
      </button>
      <button class="nav-tab" data-page="sheet">
        <span class="nav-icon">üìä</span>
        <span class="nav-label">Sheet</span>
      </button>
      <button class="nav-tab" data-page="options">
        <span class="nav-icon">‚öôÔ∏è</span>
        <span class="nav-label">Options</span>
      </button>
    </footer>

    <!-- Sandbox Mode Badge (moved to bottom) -->
    <div id="sandboxBadge" class="sandbox-badge hidden">
      <a href="#" id="sandboxLink" class="sandbox-link">üß™ Sandbox Mode</a>
      <span class="sandbox-divider"> ‚Ä¢ </span>
      <a href="#" id="privacyLink" class="privacy-link">üîí Privacy First</a>
    </div>

    <!-- Connection Success Modal -->
    <div id="connectionSuccessModal" class="modal hidden">
      <div class="modal-overlay"></div>
      <div class="modal-content">
        <!-- Page 1: Celebration -->
        <div id="modalPage1" class="modal-page">
          <div class="modal-header">
            <div class="modal-icon">üéâ</div>
            <h2>You're connected!</h2>
          </div>

          <p class="modal-description" id="connectionSuccessDescription">
            Your bank account is now linked. You're ready to sync transactions to Google Sheets.
          </p>

          <div class="modal-actions">
            <button id="modalNextBtn" class="btn btn-primary">
              Next
            </button>
          </div>
        </div>

        <!-- Page 2: Next Steps -->
        <div id="modalPage2" class="modal-page hidden">
          <div class="modal-header">
            <h2>Connect a Google Sheet</h2>
          </div>

          <p class="modal-description">
            Follow these steps to link your spreadsheet:
          </p>

          <ol class="modal-steps">
            <li><strong>Create or open a Google Sheet</strong></li>
            <li><strong>Copy the URL</strong> from your browser</li>
            <li><strong>Paste it below</strong> and click "Save Sheet"</li>
          </ol>

          <div class="modal-actions">
            <button id="closeSuccessModal" class="btn btn-primary">
              Got it!
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Sheet Success Modal -->
    <div id="sheetSuccessModal" class="modal hidden">
      <div class="modal-overlay"></div>
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-icon">üéâ</div>
          <h2>You synced your first data!</h2>
        </div>

        <p class="modal-description" id="sheetSuccessDescription">
          Your Google Sheet is now live with sandbox transactions including balances, categories, and sample activity powered by SheetLink.
        </p>

        <div class="modal-actions">
          <button id="syncSuccessOpenSheet" class="btn btn-primary">
            üîó Open my Linked Sheet
          </button>
          <button id="syncSuccessViewAccounts" class="btn btn-text">
            Done
          </button>
        </div>

        <p class="modal-footer" id="sheetSuccessFooter" style="margin-top: 16px; font-size: 12px; color: #666; text-align: center;">
          <!-- Dynamically set based on CONFIG.ENV in popup.js -->
        </p>
      </div>
    </div>
  </div>

  <!-- Configuration -->
  <script type="module" src="../config.js"></script>

  <!-- Google Sheets API wrapper -->
  <script src="sheets.js"></script>

  <!-- Rules engine -->
  <script type="module" src="rules.js"></script>

  <!-- Drive API wrapper -->
  <script src="drive.js"></script>

  <!-- Walkthrough Modal -->
  <script src="components/WalkthroughModal.js"></script>

  <!-- Main popup logic -->
  <script type="module" src="popup.js"></script>
</body>
</html>
